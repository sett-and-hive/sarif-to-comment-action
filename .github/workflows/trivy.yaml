# A workflow that runs Trivy to scan the action Docker image

name: Trivy workflow

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '43 12 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: trivy-${{ github.ref }}
  cancel-in-progress: false

env:
  TRIVY_SEVERITY: CRITICAL,HIGH
  APP_IMAGE_TAG: docker-opp-capture-app:latest
  DOCKERFILE_PATH: devops/docker/Dockerfile
  TRIVY_CACHE_DIR: .trivy

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout source
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      # 1. Manual Cache Control: Solves "stale version" errors
      # We cache the .trivy directory. If the Trivy version changes or DB corrupts,
      # you can clear cache via GitHub UI or change the key prefix.
      - name: Cache Trivy DB
        uses: actions/cache@0c45773b623bea8c8e75f6c82b208c3cf94ea4f9 # v4.0.2
        with:
          path: ${{ env.TRIVY_CACHE_DIR }}
          # unique key ensures we save a new cache every run
          key: ${{ runner.os }}-trivy-db-${{ github.run_id }}
          # restore-keys allows us to fetch the most recent previous cache
          restore-keys: |
            ${{ runner.os }}-trivy-db-

      # 2. Setup Buildx for faster builds (layer caching)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0

      - name: Build and load app image
        uses: docker/build-push-action@4a13e500e55cf31b7a5d59a38ab2040ab0f42f56 # v5.1.0
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          tags: ${{ env.APP_IMAGE_TAG }}
          load: true # Essential: loads image into docker daemon so Trivy can see it
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 3. Scan Config (Terraform/Dockerfiles)
      - name: Run Trivy config scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          scan-type: config
          hide-progress: false
          output: trivy-config.txt
          severity: CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN
          ignore-unfixed: true
          cache-dir: ${{ env.TRIVY_CACHE_DIR }} # Use our manual cache

      # 4. Scan The Built Image
      - name: Run Trivy image scanner on App
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          scan-type: image
          image-ref: "${{ env.APP_IMAGE_TAG }}"
          hide-progress: false
          output: trivy-app-image.txt
          severity: ${{ env.TRIVY_SEVERITY }}
          ignore-unfixed: true
          cache-dir: ${{ env.TRIVY_CACHE_DIR }} # Use our manual cache
          # exit-code: 1 # Uncomment if you want to fail build on detection

      - name: Publish Trivy Output to Summary
        if: always()
        run: |
          {
            echo "### üõ°Ô∏è Trivy Scan Results"
            
            if [[ -s trivy-config.txt ]]; then
              echo "#### Config Scan"
              echo "<details><summary>Expand Details</summary>"
              echo ""
              echo '```'
              cat trivy-config.txt
              echo '```'
              echo "</details>"
            fi

            if [[ -s trivy-app-image.txt ]]; then
              echo "#### Image Scan (${{ env.APP_IMAGE_TAG }})"
              echo "<details><summary>Expand Details</summary>"
              echo ""
              echo '```'
              cat trivy-app-image.txt
              echo '```'
              echo "</details>"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Trivy reports
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
            name: trivy-app-reports
            path: |
              trivy-config.txt
              trivy-app-image.txt

      # 5. PR Commenting Logic
      - name: Prepare PR comment
        if: github.event_name == 'pull_request'
        id: prep-comment
        run: |
          CONFIG_REPORT="trivy-config.txt"
          IMAGE_REPORT="trivy-app-image.txt"

          BODY="## üõ°Ô∏è Trivy Scan Report
          "

          # Config Section
          if grep -q "Total: " "$CONFIG_REPORT"; then
            BODY+="### üîß Config Scan: ‚ö†Ô∏è Issues Found
            <details><summary>Show Findings</summary>

            \`\`\`terraform
            $(cat $CONFIG_REPORT)
            \`\`\`
            </details>
            "
          else
            BODY+="### üîß Config Scan: ‚úÖ Clean
            "
          fi

          # Image Section
          if grep -q "Total: " "$IMAGE_REPORT"; then
            BODY+="### üê≥ Image Scan: ‚ùå Vulnerabilities Found
            <details><summary>Show Findings</summary>

            \`\`\`
            $(cat $IMAGE_REPORT)
            \`\`\`
            </details>"
          else
            BODY+="### üê≥ Image Scan: ‚úÖ Clean"
          fi

          BODY+=""
          echo "$BODY" > pr-comment-body.md

      - name: Find existing comment
        if: ${{ github.event_name == 'pull_request' }}
        id: fc
        uses: peter-evans/find-comment@b30e6a3c0ed37e7c023ccd3f1db5c6c0b0c23aad # v4.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: ''

      - name: Post findings to PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: pr-comment-body.md
          edit-mode: replace

  # 6. Issue Creation Logic (Kept largely the same)
  create-vulnerability-issues:
    runs-on: ubuntu-latest
    needs: build-and-scan
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout source
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Download Trivy reports
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: trivy-app-reports
          # No merge-multiple needed as we only have one source now

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Create GitHub issues for vulnerabilities
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # Ensure your python script looks for 'trivy-app-image.txt' and 'trivy-config.txt'
          python .github/scripts/create_trivy_issues.py